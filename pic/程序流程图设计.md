# 乒乓球培训管理系统 - 程序流程图设计

## 1. 流程图设计说明

本文档包含乒乓球培训管理系统的关键业务流程图，使用标准流程图符号，展示系统主要功能的处理逻辑和控制流程。

## 2. 用户注册流程图

### 2.1 学员注册流程

```
开始
  ↓
填写注册信息
  ↓
验证信息格式 ← 格式错误 → 提示错误信息 ↑
  ↓ 格式正确                         │
检查用户名是否重复 ← 重复 → 提示用户名已存在 ↑
  ↓ 不重复                              │
检查手机号是否重复 ← 重复 → 提示手机号已注册 ↑
  ↓ 不重复                              │
检查邮箱是否重复 ← 重复 → 提示邮箱已注册 ↑
  ↓ 不重复                              │
加密存储密码
  ↓
生成用户ID
  ↓
保存用户信息到数据库
  ↓
发送注册成功通知
  ↓
结束
```

### 2.2 教练注册流程

```
开始
  ↓
填写注册信息（包括照片和成绩）
  ↓
验证信息格式 ← 格式错误 → 提示错误信息 ↑
  ↓ 格式正确                         │
检查用户名是否重复 ← 重复 → 提示用户名已存在 ↑
  ↓ 不重复                              │
上传照片文件 ← 上传失败 → 提示上传失败 ↑
  ↓ 上传成功                           │
生成申请ID
  ↓
保存申请信息到数据库
  ↓
设置状态为"待审核"
  ↓
通知校区管理员审核
  ↓
发送申请提交成功通知
  ↓
结束
```

## 3. 用户登录流程图

```
开始
  ↓
输入用户名和密码
  ↓
验证输入格式 ← 格式错误 → 提示格式错误 ↑
  ↓ 格式正确                         │
查询用户信息 ← 用户不存在 → 提示用户不存在 ↑
  ↓ 用户存在                            │
验证密码 ← 密码错误 → 提示密码错误 ↑
  ↓ 密码正确                      │
检查账户状态 ← 账户被禁用 → 提示账户被禁用 ↑
  ↓ 账户正常                              │
生成JWT令牌
  ↓
更新最后登录时间
  ↓
记录登录日志
  ↓
返回令牌和用户信息
  ↓
结束
```

## 4. 教练选择流程图

### 4.1 学员选择教练流程

```
开始
  ↓
学员查询教练列表
  ↓
选择目标教练
  ↓
检查是否已选择该教练 ← 已选择 → 提示已选择该教练 ↑
  ↓ 未选择                                │
检查学员选择教练数量 ← 已达上限(2个) → 提示选择数量已满 ↑
  ↓ 未达上限                                    │
检查教练学员数量 ← 已达上限(20个) → 提示教练学员已满 ↑
  ↓ 未达上限                                    │
创建选择申请记录
  ↓
设置申请状态为"待审核"
  ↓
发送申请通知给教练
  ↓
提示申请已提交
  ↓
结束
```

### 4.2 教练审核申请流程

```
开始
  ↓
教练查看申请通知
  ↓
查看学员详细信息
  ↓
做出审核决定（同意/拒绝）
  ↓
                     同意 ↓               ↓ 拒绝
            检查教练学员数量上限      填写拒绝原因
                     ↓                    ↓
         已达上限 → 提示无法接收更多学员    更新申请状态为"已拒绝"
                     ↓ 未达上限            ↓
         更新申请状态为"已建立"            记录拒绝原因
                     ↓                    ↓
         增加教练当前学员数               发送拒绝通知给学员
                     ↓                    ↓
         创建师生关系记录                 结束
                     ↓
         发送成功通知给学员
                     ↓
                   结束
```

## 5. 课程预约流程图

### 5.1 学员预约课程流程

```
开始
  ↓
学员选择教练
  ↓
检查师生关系 ← 无师生关系 → 提示需要先选择教练 ↑
  ↓ 关系存在                              │
查看教练课表
  ↓
选择时间段
  ↓
检查时间冲突 ← 时间冲突 → 提示时间冲突 ↑
  ↓ 无冲突                          │
选择球台或自动分配
  ↓
检查球台可用性 ← 球台被占用 → 提示球台不可用 ↑
  ↓ 球台可用                                │
计算课时费
  ↓
检查账户余额 ← 余额不足 → 提示余额不足，建议充值 ↑
  ↓ 余额充足                                      │
创建预约记录
  ↓
设置状态为"待确认"
  ↓
发送预约通知给教练
  ↓
提示预约申请已提交
  ↓
结束
```

### 5.2 教练确认预约流程

```
开始
  ↓
教练查看预约通知
  ↓
查看预约详情
  ↓
做出确认决定（确认/拒绝）
  ↓
              确认 ↓                    ↓ 拒绝
    检查教练时间是否冲突          填写拒绝原因
              ↓                         ↓
    冲突 → 提示时间冲突，无法确认      更新预约状态为"已取消"
              ↓ 无冲突                   ↓
    从学员账户扣除课时费              发送拒绝通知给学员
              ↓                         ↓
    更新预约状态为"已确认"            结束
              ↓
    更新球台占用状态
              ↓
    发送确认通知给学员
              ↓
    设置上课提醒
              ↓
            结束
```

### 5.3 取消预约流程

```
开始
  ↓
用户发起取消申请
  ↓
检查取消时间限制 ← 不足24小时 → 提示无法取消 ↑
  ↓ 满足24小时                           │
检查当月取消次数 ← 已达3次上限 → 提示取消次数已满 ↑
  ↓ 未达上限                                  │
创建取消申请记录
  ↓
发送取消通知给对方
  ↓
等待对方确认
  ↓
对方确认 ← 对方拒绝 → 通知取消失败 ↑
  ↓                              │
更新预约状态为"已取消"
  ↓
退还课时费到学员账户
  ↓
释放球台占用状态
  ↓
增加取消次数计数
  ↓
发送取消成功通知
  ↓
结束
```

## 6. 收费管理流程图

### 6.1 账户充值流程

```
开始
  ↓
用户选择充值金额
  ↓
选择支付方式（微信/支付宝/线下）
  ↓
线下支付 ↓                          ↓ 在线支付
管理员录入充值信息              生成支付订单
  ↓                                ↓
验证金额和用户信息              调用第三方支付API
  ↓                                ↓
  ↓                    支付失败 ← 等待支付结果 → 支付成功
  ↓ ←──────────────────────┘                    ↓
创建交易记录                                  接收支付回调
  ↓                                          ↓
更新账户余额                                验证支付结果
  ↓                                          ↓
发送充值成功通知                            创建交易记录
  ↓                                          ↓
结束                                        更新账户余额
                                           ↓
                                        发送充值成功通知
                                           ↓
                                         结束
```

### 6.2 课时费扣费流程

```
开始
  ↓
系统接收扣费请求
  ↓
获取用户账户信息
  ↓
检查账户余额 ← 余额不足 → 返回扣费失败 ↑
  ↓ 余额充足                      │
计算扣费金额
  ↓
开始数据库事务
  ↓
扣除账户余额
  ↓
创建扣费交易记录
  ↓
更新账户最后操作时间
  ↓
提交数据库事务 ← 提交失败 → 回滚事务，返回扣费失败 ↑
  ↓ 提交成功                                    │
发送扣费通知
  ↓
返回扣费成功
  ↓
结束
```

## 7. 比赛报名流程图

### 7.1 学员报名比赛流程

```
开始
  ↓
查看可报名比赛列表
  ↓
选择目标比赛
  ↓
检查报名时间 ← 报名已截止 → 提示报名已截止 ↑
  ↓ 在报名期内                        │
检查是否已报名 ← 已报名 → 提示已报名该比赛 ↑
  ↓ 未报名                              │
选择参赛组别（甲/乙/丙）
  ↓
检查账户余额 ← 余额不足 → 提示余额不足，建议充值 ↑
  ↓ 余额充足                                    │
从账户扣除报名费
  ↓
创建报名记录
  ↓
设置缴费状态为"已缴费"
  ↓
创建报名费交易记录
  ↓
发送报名成功通知
  ↓
结束
```

### 7.2 比赛分组排程流程

```
开始
  ↓
管理员启动分组排程
  ↓
获取各组别报名学员
  ↓
                甲组学员 ↓    ↓ 乙组学员    ↓ 丙组学员
                      按组别分别处理
                           ↓
              检查每组参赛人数 ← 人数为0 → 跳过该组 ↑
                     ↓ 有参赛者                │
              人数 ≤ 6 ↓               ↓ 人数 > 6
            采用全循环赛制          进一步分小组
                     ↓                    ↓
            生成全循环赛程          小组内全循环
                     ↓                    ↓
            随机分配球台          小组前两名交叉淘汰
                     ↓                    ↓
                 ←──── 生成最终赛程 ────→
                           ↓
                 保存赛程到数据库
                           ↓
                 发送赛程通知给参赛者
                           ↓
                         结束
```

## 8. 课后评价流程图

```
开始
  ↓
系统检测课程结束
  ↓
向学员和教练发送评价请求
  ↓
用户点击评价链接
  ↓
验证用户权限 ← 权限不足 → 提示权限错误 ↑
  ↓ 权限验证通过                     │
检查是否已评价 ← 已评价 → 显示已有评价 ↑
  ↓ 未评价                            │
显示评价表单
  ↓
用户填写评价内容
  ↓
提交评价
  ↓
验证评价内容 ← 内容为空 → 提示请填写评价内容 ↑
  ↓ 内容有效                              │
保存评价记录
  ↓
更新评价状态
  ↓
发送评价成功通知
  ↓
通知对方有新评价
  ↓
结束
```

## 9. 系统日志记录流程图

```
开始（用户操作发生）
  ↓
捕获操作事件
  ↓
获取操作用户信息
  ↓
获取操作类型和内容
  ↓
获取客户端IP地址
  ↓
获取当前时间戳
  ↓
构造日志记录对象
  ↓
异步写入日志数据库 ← 写入失败 → 重试写入（最多3次）
  ↓ 写入成功                        ↓ 重试失败
检查日志级别                   记录到错误日志文件
  ↓                                  ↓
重要操作 ↓           ↓ 一般操作        ↓
发送实时告警    正常记录完成      记录完成
  ↓                ↓              ↓
结束           结束           结束
```

## 10. 权限验证流程图

```
开始（用户访问资源）
  ↓
提取请求中的Token
  ↓
检查Token是否存在 ← Token不存在 → 返回401未授权 ↑
  ↓ Token存在                           │
验证Token格式 ← 格式错误 → 返回401未授权 ↑
  ↓ 格式正确                             │
解析Token获取用户ID
  ↓
查询用户信息 ← 用户不存在 → 返回401未授权 ↑
  ↓ 用户存在                             │
检查用户状态 ← 用户被禁用 → 返回403禁止访问 ↑
  ↓ 用户正常                               │
获取用户角色权限
  ↓
检查资源访问权限 ← 权限不足 → 返回403禁止访问 ↑
  ↓ 权限充足                                │
记录访问日志
  ↓
允许访问资源
  ↓
结束
```

## 11. 数据备份流程图

```
开始（定时任务触发）
  ↓
检查系统负载 ← 负载过高 → 延迟备份 ↑
  ↓ 负载正常                    │
获取当前时间戳
  ↓
生成备份文件名
  ↓
创建数据库连接
  ↓
开始数据导出 ← 导出失败 → 记录错误日志 → 发送告警通知
  ↓ 导出成功                                    ↓
压缩备份文件                                  结束
  ↓
上传到备份服务器 ← 上传失败 → 重试上传（最多3次）
  ↓ 上传成功                         ↓ 重试失败
删除本地临时文件                   记录错误日志
  ↓                                  ↓
清理过期备份文件                   发送告警通知
  ↓                                  ↓
记录备份成功日志                   结束
  ↓
发送成功通知
  ↓
结束
```

## 12. 异常处理流程图

```
开始（系统异常发生）
  ↓
捕获异常信息
  ↓
判断异常类型
  ↓
业务异常 ↓        ↓ 系统异常        ↓ 数据库异常
生成友好错误信息   记录详细错误日志   检查数据库连接
  ↓               ↓                 ↓
返回错误响应      发送告警通知       连接正常 ↓  ↓ 连接异常
  ↓               ↓                        ↓    启动连接恢复
记录操作日志      尝试系统恢复          重试操作    ↓
  ↓               ↓                        ↓    ↓ 恢复失败
结束             结束                   成功 → 结束   发送紧急告警
                                       ↓             ↓
                                    记录成功日志    结束
                                       ↓
                                     结束
```

## 13. 流程图符号说明

- **椭圆形**: 开始/结束
- **矩形**: 处理步骤
- **菱形**: 判断条件
- **平行四边形**: 输入/输出
- **圆形**: 连接点
- **箭头**: 流程方向

## 14. 流程设计原则

1. **清晰性**: 流程步骤清晰明确，逻辑关系清楚
2. **完整性**: 覆盖所有可能的执行路径和异常情况
3. **一致性**: 同类操作采用一致的处理逻辑
4. **可扩展性**: 预留扩展接口，便于功能升级
5. **安全性**: 包含必要的权限检查和数据验证
6. **可维护性**: 模块化设计，便于后期维护和修改